# Исправление проблемы перезагрузки Arduino

## Проблема
Arduino перезагружался при получении команд от приложения.

## Причина
1. **DTR сигнал** - SerialPort по умолчанию включает DTR, который сбрасывает Arduino при открытии порта
2. **Недостаточная задержка** - Arduino не успевал инициализироваться после открытия порта
3. **Переполнение буфера** - команды отправлялись слишком быстро

## Решение

### 1. Изменения в коде

#### SerialWorker.cs
- Добавлен виртуальный метод `ConfigurePort()` для настройки порта перед открытием
- Добавлен виртуальный метод `GetOpenDelayMs()` для задержки после открытия

#### Devices.cs (ArduinoClientSerial)
- Переопределён `ConfigurePort()` - отключает DTR/RTS для Arduino
- Переопределён `GetOpenDelayMs()` - добавляет задержку 2000мс после открытия
- Добавлена задержка после каждой команды (текстовой и бинарной)

### 2. Изменения в конфигурации (App.config)

Добавлены новые параметры:
```xml
<!-- Отключение DTR/RTS для предотвращения перезагрузки -->
<add key="ArduinoDtr" value="false" />
<add key="ArduinoRts" value="false" />

<!-- Задержка после открытия порта (мс) -->
<add key="ArduinoOpenDelayMs" value="2000" />

<!-- Задержка после отправки команды (мс) -->
<add key="ArduinoCommandDelayMs" value="50" />
```

## Как проверить, что исправление работает

1. **Проверьте логи** (`Logs/arduino.log`):
   ```
   CONFIG: DTR=false, RTS=false  ← должно быть false
   OPENED (Arduino ready)        ← должно появиться после задержки
   >> BIN TAKEFRONT: ...         ← команды должны отправляться
   ```

2. **Наблюдайте за Arduino:**
   - Светодиод не должен мигать при каждой команде
   - Arduino не должен перезагружаться
   - Команды должны выполняться корректно

3. **Если проблема сохраняется:**
   - Увеличьте `ArduinoOpenDelayMs` до 3000-5000
   - Увеличьте `ArduinoCommandDelayMs` до 100-200
   - Проверьте питание Arduino (качественный USB-кабель, отдельный порт)

## Технические детали

### DTR (Data Terminal Ready)
- По умолчанию SerialPort включает DTR при открытии
- На Arduino DTR подключен к линии сброса (RESET)
- Когда DTR меняется с HIGH на LOW, Arduino перезагружается
- **Решение:** Отключить DTR через `port.DtrEnable = false`

### Задержка после открытия
- Arduino нужно время для инициализации после подключения
- По умолчанию 2000мс достаточно для большинства плат
- Для больших скетчей может потребоваться больше времени

### Задержка между командами
- Предотвращает переполнение буфера Serial на Arduino
- Даёт Arduino время обработать предыдущую команду
- 50мс обычно достаточно, но можно увеличить при необходимости

## Файлы, которые были изменены

1. `SerialWorker.cs` - добавлены виртуальные методы для настройки порта
2. `Devices.cs` - переопределены методы для Arduino
3. `App.config` - добавлены параметры конфигурации
4. `ARDUINO_SETUP.md` - обновлена документация

## Обратная совместимость

✅ Все изменения обратно совместимы:
- Если параметры не указаны в конфиге, используются безопасные значения по умолчанию
- DTR отключен по умолчанию для Arduino
- Задержки применяются только для Arduino, другие устройства не затронуты

